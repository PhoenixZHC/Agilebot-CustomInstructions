# 更新Mac地址使用说明

## PowerShell中文乱码解决方案

PowerShell中文乱码多是编码不匹配导致，可通过临时设置快速解决，也能配置永久生效，具体方法如下：

### 1. 临时修复（仅当前窗口生效）

打开PowerShell后输入命令 `chcp 65001` 切换为UTF-8编码，或输入 `$OutputEncoding = [Console]::OutputEncoding = [System.Text.Encoding]::UTF8`，两种方式都能快速让当前窗口中文正常显示，关闭窗口后设置失效。

### 2. 永久配置（通过配置文件）

先输入 `New-Item -Path $PROFILE -Type File -Force` 创建配置文件；再输入 `code $PROFILE` 打开文件，添加 `chcp 65001` 和 `[Console]::OutputEncoding = [Console]::InputEncoding = [System.Text.Encoding]::UTF8`；保存后重启PowerShell，后续打开都会默认用UTF-8编码。

### 3. 全局根治（修改系统设置）

按下Win + I打开设置，进入"时间和语言→语言和区域"，点击"管理语言设置"；在弹出的"区域"窗口切换到"管理"选项卡，点击"更改系统区域设置"，勾选"Beta版：使用Unicode UTF-8提供全球语言支持"，重启电脑后，PowerShell及系统全局中文显示都会正常。

## 一、工具简介

本工具用于配置本地网络IP地址并更新控制柜的MAC地址。工具支持中文界面，操作简单，一键运行。

## 二、系统要求

- **操作系统**: Windows 10/11
- **权限要求**: 管理员权限
- **必需组件**:
  - PowerShell 5.1 或更高版本
  - OpenSSH 客户端（Windows 10 1809+ 自带）

## 三、文件说明

### 主要文件

1. **更新Mac地址.bat**
   - 主启动文件
   - 双击即可运行
   - 自动检查管理员权限
   - 自动设置UTF-8编码

2. **network_config_simple.ps1**
   - PowerShell主脚本
   - 包含所有网络配置逻辑
   - 自动处理中文显示

## 四、使用步骤

### 步骤1：启动工具

1. 双击 **更新Mac地址.bat** 文件
2. 如果出现UAC提示，点击"是"允许运行
3. 等待工具启动

### 步骤2：选择网络适配器

工具会自动检测所有网络适配器，显示如下信息：

```
[1] WLAN - Status: Connected
[2] 蓝牙网络 - Status: Connected
[3] 以太网2 - Status: Connected
[4] 以太网 - Status: Connected
```

**操作**：
- 根据提示输入数字（1-4）选择要配置的网络适配器
- 建议选择有线网络适配器（以太网）

### 步骤3：输入控制柜IP地址

**操作**：
- 根据提示输入控制柜的IP地址
- 例如：`192.168.110.2`
- 按Enter确认

### 步骤4：配置本地网络（步骤1）

工具会自动：
1. 计算本地IP地址（与控制柜IP在同一子网）
2. 计算子网掩码
3. 配置本地网络适配器的IP地址

**显示信息**：
- 控制柜IP: 192.168.110.2
- 计算出的本地IP: 192.168.110.xxx
- 子网掩码: 255.255.255.0
- 本地网络配置: 成功

### 步骤5：更新控制柜MAC地址（步骤2）

工具会：
1. 连接到控制柜
2. 提示输入SSH密码

**操作**：
- 当出现密码提示时，输入密码：`root`
- 密码输入会被隐藏（这是SSH的安全特性）
- 如果密码错误，会提示"密码错误，请重新输入"
- 最多可以重试5次

**成功提示**：
- 密码输入: 正确（绿色）
- SSH连接成功，命令已执行

**失败提示**：
- 如果控制柜连接不上，会显示：
  - 控制柜链接不上（红色）
  - 请检查:（红色）
    - 1. 控制柜已开机（红色）
    - 2. 网线已连接（红色）
    - 3. IP地址正确: 192.168.110.2（红色）
    - 4. 本地IP在同一子网（红色）
  - 然后终止后续操作

## 五、常见问题

### 1. 窗口显示乱码或叠字

**解决方法**：
- 不要调整窗口大小（窗口已锁定）
- 如果仍有问题，检查控制台字体设置：
  1. 右键点击窗口标题栏
  2. 选择"属性" -> "字体"
  3. 选择支持中文的字体（推荐：新宋体、Consolas）

### 2. 提示"需要管理员权限"

**解决方法**：
- 右键点击 **更新Mac地址.bat**
- 选择"以管理员身份运行"

### 3. 提示"未找到SSH客户端"

**解决方法**：
1. 打开"设置" -> "应用" -> "可选功能"
2. 搜索"OpenSSH客户端"
3. 如果没有，点击"添加功能"安装

### 4. 控制柜连接不上

**检查项**：
1. ✓ 控制柜已开机
2. ✓ 网线已连接
3. ✓ IP地址正确
4. ✓ 本地IP在同一子网

**解决方法**：
- 检查网线连接
- 确认控制柜IP地址正确
- 确认本地IP地址与控制柜IP在同一子网
- 检查控制柜SSH服务是否运行

### 5. 密码输入错误

**解决方法**：
- 确认密码为：`root`
- 密码输入时不会显示（这是SSH的安全特性）
- 可以重试，最多5次

### 6. MAC地址更新失败

**可能原因**：
- 控制柜上的 `/etc/network/interfaces` 文件不存在
- SSH连接失败
- 密码错误

**解决方法**：
- 检查控制柜系统配置
- 确认SSH连接正常
- 确认密码正确

## 六、功能说明

### 1. 自动计算本地IP

工具会自动计算本地IP地址：
- 保持与控制柜IP的前3个字节相同
- 最后一个字节随机生成（2-255）

### 2. 自动计算子网掩码

根据IP地址自动计算子网掩码：
- 10.x.x.x → 255.0.0.0
- 172.16-31.x.x → 255.255.0.0
- 192.168.x.x → 255.255.255.0
- 其他 → 255.255.255.0

### 3. MAC地址更新

工具会在控制柜上：
1. 备份 `/etc/network/interfaces` 文件
2. 检查是否存在 `hwaddress ether` 行
3. 如果存在，更新MAC地址
4. 如果不存在，添加 `hwaddress ether` 行
5. 生成随机MAC地址

**重要提示**：如果出现 `hwaddress ether`，必须显示完整的 `hwaddress ether` 行，包括具体的MAC地址。

**示例**：
```
hwaddress ether 00:01:02:04:A8:17
```

工具会自动显示完整的 `hwaddress ether` 行，例如：`hwaddress ether 00:01:02:04:A8:17`，而不是只显示 `hwaddress ether`。

### 4. 窗口锁定

- 窗口大小已锁定，无法调整
- 防止窗口大小改变导致的显示问题

## 七、注意事项

1. **管理员权限**：工具需要管理员权限才能修改网络配置
2. **网络中断**：配置IP地址时，网络可能会短暂中断
3. **密码安全**：SSH密码输入时不会显示，这是正常的安全特性
4. **窗口大小**：不要尝试调整窗口大小，已锁定防止显示问题
5. **文件编码**：脚本文件必须使用UTF-8编码（无BOM）

## 八、技术支持

如果遇到问题：
1. 检查错误提示信息
2. 按照提示的检查项逐一排查
3. 确认网络连接正常
4. 确认控制柜SSH服务运行正常

## 九、更新日志

### 版本特性
- 支持中文界面
- 自动网络配置
- 自动MAC地址更新
- 密码重试功能
- 连接失败检测
- 窗口大小锁定
- 防止显示乱码

---

**版本**: 1.0
**更新日期**: 2025年12月5日
**作者**: Spoil

